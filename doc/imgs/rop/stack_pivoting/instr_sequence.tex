\documentclass[../tfg.tex]{subfiles}

\begin{document}

\begin{lstlisting}[escapechar = @]
mov esp, ebp
pop ebp@\tikz[remember picture] \node (newstack) {};@
ret@\tikz[remember picture] \node (gadget) {};@
mov esp, ebp@\tikz[remember picture] \node (pivot) {};@
pop ebp@\tikz[remember picture] \node (garbage) {};@
ret@\tikz[remember picture] \node (win) {};@
\end{lstlisting}

\begin{tikzpicture}[remember picture, overlay]

\node (addrbuff) [right=1cm of newstack, fill=red!20] {\texttt{\&buffer}};
\node (leave) [right=4cm of gadget, fill=red!20] {\texttt{leave} gadget};
\node (stack) [right=6cm of pivot, fill=red!20] {Stack pivoting};
\node (firstbytes) [right=1cm of garbage, fill=red!20] {First 4 bytes of \texttt{buffer}};
\node (winaddr) [right=2cm of win, fill=red!20] {\texttt{\&win}};

\draw [-{Latex[round]}] (addrbuff.west) -- (newstack.east);
\draw [-{Latex[round]}] (leave.west) -- (gadget.east);
\draw [-{Latex[round]}] (stack.west) -- (pivot.east);
\draw [-{Latex[round]}] (firstbytes.west) -- (garbage.east);
\draw [-{Latex[round]}] (winaddr.west) -- (win.east);

\end{tikzpicture}

\end{document}

