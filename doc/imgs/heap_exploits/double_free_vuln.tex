\documentclass[../tfg.tex]{subfiles}

\begin{document}

\begin{lstlisting}[escapechar = @]
#include <stdlib.h>

int main()
{
    void* a = malloc(8);

    free(a);@\tikz[remember picture] \node (free1) {};@
    free(a);@\tikz[remember picture] \node (free2) {};@

\end{lstlisting}


\begin{tikzpicture}
[remember picture,
    heapchunk/.style={minimum width=1.5cm, minimum height=0.8cm, fill=red!20}]

    \node (chunk1) [heapchunk] {\texttt{a}'s chunk};
    \node (chunk2) [heapchunk, right=1cm of chunk1.east] {\texttt{a}'s chunk};
    \node (bin) [heapchunk, minimum width=1cm, left=1cm of chunk1.west] {free bin};

    \draw [-{Latex[round]}] (bin.east) -- (chunk1.west);
    \draw [{Latex[round]}-{Latex[round]}] (chunk1.east) -- (chunk2.west);

\end{tikzpicture}


\begin{lstlisting}[escapechar = @, firstnumber=11]

    void* b = malloc(8);@\tikz[remember picture] \node (malloc1) {};@
    void* c = malloc(8);@\tikz[remember picture] \node (malloc2) {};@

    /* b and c point to the same address */

    return 0;
}
\end{lstlisting}


\begin{tikzpicture}[remember picture, overlay]

    %\node (doublefree) [above=2cm of free2, right=2cm of free2, fill=red!20] {Double free vulnerability};

    %\draw [-{Latex[round]}] (doublefree.west) -- (free2.east);

    \path [bend left, -{Latex[round]}] (free1) edge node [auto] {append} (chunk1.north);
    \path [bend left, -{Latex[round]}] (free2) edge node [auto] {append} (chunk2.north);

    \path [bend left, -{Latex[round]}] (chunk1.south) edge node [auto] {malloc} (malloc1);
    \path [bend left, -{Latex[round]}] (chunk2.south) edge node [auto] {malloc} (malloc2);

\end{tikzpicture}


\end{document}

