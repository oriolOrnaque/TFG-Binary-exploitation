\documentclass[../tfg.tex]{subfiles}

\begin{document}

\begin{minipage}[c]{0.33\linewidth}
\begin{lstlisting}[escapechar = !]
void foo( int arg!\tikz[remember picture] \node (carg) {};!)
{
    int a;!\tikz[remember picture] \node (clocal) {};!
}

int main()
{
    foo(1);!\tikz[remember picture] \node (ccall) {};!

    return 0;
}
\end{lstlisting}
\end{minipage}
\begin{minipage}[c]{0.28\linewidth}
    \begin{lstlisting}[language = {[x86masm]Assembler}, escapechar = !]
foo:
    !\tikz[remember picture] \node (asmebp) {};!push ebp!\tikz[remember picture] \node (asm2ebp) {};!
     mov ebp, esp
    !\tikz[remember picture] \node (asmlocal) {};!sub esp, 4!\tikz[remember picture] \node (asm2local) {};!
    ...

main:
    ...
    !\tikz[remember picture] \node (asmarg) {};!push 1!\tikz[remember picture] \node (asm2arg) {};!
    !\tikz[remember picture] \node (asmcall) {};!call foo!\tikz[remember picture] \node (asm2call) {};!
    ...
\end{lstlisting}
\end{minipage}
\begin{minipage}[c]{0.25\linewidth}
\begin{tikzpicture}
[remember picture, stacknode/.style={rectangle, minimum width=3cm, minimum height=1cm, text centered, outer sep=0}]

\node (stacklocal1) [stacknode, fill=cyan!20] {a};
\node (savedebp) [stacknode, below=0 of stacklocal1.south, fill=cyan!35] {saved bp};
\node (savedeip) [stacknode, below=0 of savedebp.south, fill=cyan!50] {saved ip};
\node (stackarg1) [stacknode, below=0 of savedeip.south, fill=cyan!65] {arg};

    \node (upperaddress) [right=0 of stackarg1.south east] {\texttt{0xff...ff}};
    \node (loweraddress) [right=0 of stacklocal1.north east] {\texttt{0x00...00}};
    \node (stackframe)   [right=0 of savedebp.south east] {\texttt{foo}'s stack frame};

\end{tikzpicture}
\end{minipage}

\begin{tikzpicture}[remember picture, overlay]
    \draw [-{Latex[round]}] (carg.east) -- (asmarg.west);
    \draw [-{Latex[round]}] (clocal.east) -- (asmlocal.west);
    \draw [-{Latex[round]}] (ccall.east) -- (asmcall.west);

    \draw [-{Latex[round]}] (asm2ebp.east) -- (savedebp.west);
    \draw [-{Latex[round]}] (asm2call.east) -- (savedeip.west);
    \draw [-{Latex[round]}] (asm2local.east) -- (stacklocal1.west);
    \draw [-{Latex[round]}](asm2arg.east) -- (stackarg1.west);
\end{tikzpicture}

\end{document}

