\documentclass[../tfg.tex]{subfiles}

\begin{document}

\begin{lstlisting}[escapechar = @]
/* ... */
void complete_level()@\tikz[remember picture] \node (winfunc) {};@ {
  printf("Congratulations, you've finished " LEVELNAME " :-) Well done!\n");
  exit(0);
}

void start_level() {
  char buffer[64];@\tikz[remember picture] \node (stackbuff) {};@
  void *ret;

  gets(buffer);@\tikz[remember picture] \node (vulnfunc) {};@

  ret = __builtin_return_address(0);
  printf("and will be returning to %p\n", ret);
}

int main(int argc, char **argv) {
  printf("%s\n", BANNER);
  start_level();
}
\end{lstlisting}

\begin{tikzpicture}[remember picture, overlay]
\node (buffer) [right=2cm of stackbuff, fill=red!20] {Buffer on the stack};
  \draw [-{Latex[round]}] (buffer.west) -- (stackbuff.east);

\node (vuln) [right=2cm of vulnfunc, fill=red!20] {Vulnerable function};
  \draw [-{Latex[round]}] (vuln.west) -- (vulnfunc.east);

  \node (win) [right=2cm of winfunc.north, fill=red!20] {Win function};
  \draw [-{Latex[round]}] (win.west) -- (winfunc.east);
\end{tikzpicture}

\end{document}
